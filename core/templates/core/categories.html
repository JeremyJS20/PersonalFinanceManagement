{% extends "base.html" %}
{% load i18n static %}

{% block content %}
<div class="mb-8 flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
    <div>
        <h1 class="text-3xl font-black text-pfm-text-dark tracking-tight">{% trans "categories_title" %}</h1>
        <p class="mt-1 text-pfm-text-light">{% trans "categories_subtitle" %}</p>
    </div>
    <button id="create-group-btn"
        class="modal-open-btn flex items-center justify-center gap-2 bg-pfm-primary text-white font-bold rounded-lg px-5 py-2.5 shadow-lg shadow-pfm-primary/20 transition-all hover:bg-pfm-primary-hover hover:shadow-xl active:scale-95"
        data-pfm-modal-target="create-group-modal" data-pfm-bind-type="expenses"
        data-pfm-bind-typelabel="{% trans 'categories_expenses' %}">
        <i data-lucide="folder-plus" class="w-5 h-5"></i>
        {% trans "categories_add_group" %}
    </button>
</div>

<div class="flex flex-col gap-8 lg:flex-row lg:h-[calc(100vh-14rem)]">
    <!-- Sidebar Navigation -->
    <aside class="w-full lg:w-64 shrink-0">
        <div class="rounded-xl border border-pfm-border bg-pfm-card p-2 shadow-sm">
            <div class="mb-2 px-3 pt-2">
                <span class="text-[10px] font-bold uppercase tracking-wider text-pfm-text-light">
                    {% trans "categories_transaction_type" %}
                </span>
            </div>
            <nav class="flex flex-col gap-1" data-pfm-tab-group="category-type">
                <button
                    class="tab-btn flex items-center gap-3 rounded-lg px-3 py-3 text-sm transition-all {% if active_tab == 'expenses' %}bg-pfm-primary/10 text-pfm-primary border-l-4 border-pfm-primary font-semibold{% else %}text-pfm-text-light font-medium hover:bg-pfm-bg hover:text-pfm-text-dark{% endif %}"
                    data-pfm-tab-target="expenses" data-pfm-label="{% trans 'categories_expenses' %}">
                    <i data-lucide="trending-down" class="w-5 h-5"></i>
                    {% trans "categories_expenses" %}
                </button>
                <button
                    class="tab-btn flex items-center gap-3 rounded-lg px-3 py-3 text-sm transition-all {% if active_tab == 'income' %}bg-pfm-primary/10 text-pfm-primary border-l-4 border-pfm-primary font-semibold{% else %}text-pfm-text-light font-medium hover:bg-pfm-bg hover:text-pfm-text-dark{% endif %}"
                    data-pfm-tab-target="income" data-pfm-label="{% trans 'categories_income' %}">
                    <i data-lucide="trending-up" class="w-5 h-5"></i>
                    {% trans "categories_income" %}
                </button>
            </nav>
            <div class="mt-4 border-t border-pfm-border p-3">
                <div class="rounded-lg bg-pfm-bg p-3">
                    <p class="text-xs font-medium text-pfm-text-light">{% trans "categories_total_categories" %}</p>
                    <p class="text-xl font-bold text-pfm-text-dark">{{ total_categories }}</p>
                    <div class="mt-2 h-1.5 w-full rounded-full bg-gray-200 dark:bg-gray-700">
                        <div class="h-1.5 rounded-full bg-pfm-primary transition-all duration-500"
                            style="width: {{ categories_progress }}%"></div>
                    </div>
                </div>
            </div>
        </div>
    </aside>

    <!-- Main Content: Category Groups -->
    <div class="flex-1 overflow-y-auto pr-4 custom-scrollbar scroll-smooth space-y-6">
        <!-- Expenses Content -->
        <div data-pfm-tab-content="expenses" class="{% if active_tab != 'expenses' %}hidden {% endif %}space-y-6">
            {% if expenses_groups %}
            {% for group in expenses_groups %}
            <!-- Group Card -->
            <section class="rounded-xl border border-pfm-border bg-pfm-card shadow-sm overflow-hidden">
                <div class="flex items-center justify-between border-b border-pfm-border bg-pfm-bg/50 px-6 py-4">
                    <div class="flex items-center gap-3">
                        <div
                            class="flex h-10 w-10 items-center justify-center rounded-lg bg-pfm-primary/10 text-pfm-primary">
                            <i data-lucide="{{ group.icon|default:'folder' }}" class="w-5 h-5 font-bold"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-pfm-text-dark">{{ group.name }}</h3>
                            <p class="text-xs text-pfm-text-light">{{ group.description|default:'' }}</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <button
                            class="modal-open-btn flex h-8 w-8 items-center justify-center rounded-md text-pfm-text-light hover:bg-pfm-bg hover:text-pfm-text-dark transition-colors"
                            aria-label="{% trans 'categories_edit_group' %}" data-pfm-modal-target="create-group-modal"
                            data-pfm-bind-mode="edit" data-pfm-bind-groupid="{{ group.id }}"
                            data-pfm-bind-groupname="{{ group.name }}"
                            data-pfm-bind-groupdescription="{{ group.description|default:'' }}"
                            data-pfm-bind-groupicon="{{ group.icon|default:'folder' }}"
                            data-pfm-bind-type="{{ group.transaction_type }}"
                            data-pfm-bind-updateurl="{% url 'category_group_update' group.id %}">
                            <i data-lucide="edit-2" class="w-4 h-4"></i>
                        </button>
                        <button
                            class="modal-open-btn flex items-center gap-1 rounded-md bg-pfm-card border border-pfm-border px-3 py-1.5 text-xs font-bold text-pfm-text-dark hover:bg-pfm-bg shadow-sm transition-colors"
                            data-pfm-modal-target="add-category-modal" data-pfm-bind-group="{{ group.name }}"
                            data-pfm-bind-groupid="{{ group.id }}">
                            <i data-lucide="plus" class="w-4 h-4"></i>
                            {% trans "categories_add_category" %}
                        </button>
                    </div>
                </div>
                <div class="divide-y divide-pfm-border">
                    {% if group.categories.all %}
                    {% for category in group.categories.all %}
                    <!-- Category Item -->
                    <div
                        class="group flex items-center justify-between px-6 py-4 transition-colors hover:bg-pfm-primary/5">
                        <div class="flex items-center gap-4">
                            <div
                                class="flex h-10 w-10 items-center justify-center rounded-full bg-pfm-bg text-pfm-text-light transition-colors group-hover:bg-pfm-card group-hover:shadow-sm">
                                <i data-lucide="{{ category.icon|default:'tag' }}" class="w-5 h-5"></i>
                            </div>
                            <div>
                                <p class="text-sm font-semibold text-pfm-text-dark">{{ category.name }}</p>
                                <p class="text-xs text-pfm-text-light">{{ category.description }}</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-3 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button class="modal-open-btn text-pfm-text-light hover:text-pfm-primary"
                                aria-label="{% trans 'categories_edit_category' %}"
                                data-pfm-modal-target="add-category-modal" data-pfm-bind-mode="edit"
                                data-pfm-bind-categoryid="{{ category.id }}"
                                data-pfm-bind-categoryname="{{ category.name }}"
                                data-pfm-bind-categorydescription="{{ category.description|default:'' }}"
                                data-pfm-bind-categoryicon="{{ category.icon|default:'tag' }}"
                                data-pfm-bind-categorygroupid="{{ group.id }}"
                                data-pfm-bind-updateurl="{% url 'category_update' category.id %}">
                                <i data-lucide="edit-2" class="w-4 h-4"></i>
                            </button>
                            <button class="modal-open-btn category-delete-btn text-pfm-text-light hover:text-pfm-danger"
                                aria-label="{% trans 'categories_delete_category' %}"
                                data-pfm-modal-target="delete-category-modal"
                                data-pfm-bind-categoryid="{{ category.id }}"
                                data-pfm-bind-categoryname="{{ category.name }}"
                                data-pfm-bind-deleteurl="{% url 'category_delete' category.id %}">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                            <i data-lucide="grip-vertical" class="w-5 h-5 cursor-grab text-gray-300"
                                aria-hidden="true"></i>
                        </div>
                    </div>
                    {% endfor %}
                    {% else %}
                    <!-- Empty State for Category Group -->
                    <div class="flex flex-col items-center justify-center py-12 text-center bg-pfm-bg/20">
                        <div
                            class="mb-4 flex h-14 w-14 items-center justify-center rounded-full bg-pfm-bg text-pfm-text-light/30 shadow-inner">
                            <i data-lucide="inbox" class="w-8 h-8"></i>
                        </div>
                        <p class="text-sm font-semibold text-pfm-text-light/70 uppercase tracking-wide">
                            {% trans "categories_no_categories_in_group" %}</p>
                        <button
                            class="modal-open-btn mt-3 text-xs font-bold text-pfm-primary hover:text-pfm-primary-hover hover:underline transition-all"
                            data-pfm-modal-target="add-category-modal" data-pfm-bind-group="{{ group.name }}"
                            data-pfm-bind-groupid="{{ group.id }}">
                            + {% trans "categories_add_first_category" %}
                        </button>
                    </div>
                    {% endif %}
                </div>
            </section>
            {% endfor %}
            {% else %}
            <!-- Empty State for Categories Page (No Groups) -->
            <div
                class="flex flex-col items-center justify-center py-20 px-6 text-center rounded-2xl border-2 border-dashed border-pfm-border bg-pfm-card/50 backdrop-blur-sm shadow-sm group hover:border-pfm-primary/30 transition-all duration-300">
                <div
                    class="mb-6 flex h-20 w-20 items-center justify-center rounded-2xl bg-pfm-primary/5 text-pfm-primary shadow-lg shadow-pfm-primary/10 group-hover:scale-110 transition-transform duration-300">
                    <i data-lucide="layers" class="w-10 h-10"></i>
                </div>
                <h3 class="text-xl font-black text-pfm-text-dark mb-2">
                    {% trans "categories_no_groups_title" %}
                </h3>
                <p class="text-pfm-text-light max-w-sm mb-8 leading-relaxed font-medium">
                    {% trans "categories_no_groups_desc" %}
                </p>
                <button
                    class="modal-open-btn flex items-center gap-2 rounded-xl bg-pfm-primary px-8 py-3 text-sm font-bold text-white shadow-xl shadow-pfm-primary/20 hover:bg-pfm-primary-hover hover:shadow-2xl active:scale-95 transition-all"
                    data-pfm-modal-target="create-group-modal" data-pfm-bind-type="expenses"
                    data-pfm-bind-typelabel="{% trans 'categories_expenses' %}">
                    <i data-lucide="plus-circle" class="w-5 h-5"></i>
                    {% trans "categories_create_first_group" %}
                </button>
            </div>
            {% endif %}
        </div>

        <!-- Income Content -->
        <div data-pfm-tab-content="income" class="{% if active_tab != 'income' %}hidden {% endif %}space-y-6">
            {% if income_groups %}
            {% for group in income_groups %}
            <!-- Group Card -->
            <section class="rounded-xl border border-pfm-border bg-pfm-card shadow-sm overflow-hidden">
                <div class="flex items-center justify-between border-b border-pfm-border bg-pfm-bg/50 px-6 py-4">
                    <div class="flex items-center gap-3">
                        <div
                            class="flex h-10 w-10 items-center justify-center rounded-lg bg-green-500/10 text-green-600">
                            <i data-lucide="{{ group.icon|default:'folder' }}" class="w-5 h-5 font-bold"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-pfm-text-dark">{{ group.name }}</h3>
                            <p class="text-xs text-pfm-text-light">{{ group.description|default:'' }}</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <button
                            class="modal-open-btn flex h-8 w-8 items-center justify-center rounded-md text-pfm-text-light hover:bg-pfm-bg hover:text-green-600 transition-colors"
                            aria-label="{% trans 'categories_edit_group' %}" data-pfm-modal-target="create-group-modal"
                            data-pfm-bind-mode="edit" data-pfm-bind-groupid="{{ group.id }}"
                            data-pfm-bind-groupname="{{ group.name }}"
                            data-pfm-bind-groupdescription="{{ group.description|default:'' }}"
                            data-pfm-bind-groupicon="{{ group.icon|default:'folder' }}"
                            data-pfm-bind-type="{{ group.transaction_type }}"
                            data-pfm-bind-updateurl="{% url 'category_group_update' group.id %}">
                            <i data-lucide="edit-2" class="w-4 h-4"></i>
                        </button>
                        <button
                            class="modal-open-btn flex items-center gap-1 rounded-md bg-pfm-card border border-pfm-border px-3 py-1.5 text-xs font-bold text-pfm-text-dark hover:bg-pfm-bg shadow-sm transition-colors"
                            data-pfm-modal-target="add-category-modal" data-pfm-bind-group="{{ group.name }}"
                            data-pfm-bind-groupid="{{ group.id }}">
                            <i data-lucide="plus" class="w-4 h-4"></i>
                            {% trans "categories_add_category" %}
                        </button>
                    </div>
                </div>
                <div class="divide-y divide-pfm-border">
                    {% if group.categories.all %}
                    {% for category in group.categories.all %}
                    <div
                        class="group flex items-center justify-between px-6 py-4 transition-colors hover:bg-green-500/5">
                        <div class="flex items-center gap-4">
                            <div
                                class="flex h-10 w-10 items-center justify-center rounded-full bg-pfm-bg text-pfm-text-light">
                                <i data-lucide="{{ category.icon|default:'banknote' }}"
                                    class="w-5 h-5 text-green-600"></i>
                            </div>
                            <div>
                                <p class="text-sm font-semibold text-pfm-text-dark">{{ category.name }}</p>
                                <p class="text-xs text-pfm-text-light">{{ category.description }}</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-3 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button class="modal-open-btn text-pfm-text-light hover:text-green-600"
                                aria-label="{% trans 'categories_edit_category' %}"
                                data-pfm-modal-target="add-category-modal" data-pfm-bind-mode="edit"
                                data-pfm-bind-categoryid="{{ category.id }}"
                                data-pfm-bind-categoryname="{{ category.name }}"
                                data-pfm-bind-categorydescription="{{ category.description|default:'' }}"
                                data-pfm-bind-categoryicon="{{ category.icon|default:'tag' }}"
                                data-pfm-bind-categorygroupid="{{ group.id }}"
                                data-pfm-bind-updateurl="{% url 'category_update' category.id %}">
                                <i data-lucide="edit-2" class="w-4 h-4"></i>
                            </button>
                            <button class="modal-open-btn category-delete-btn text-pfm-text-light hover:text-pfm-danger"
                                aria-label="{% trans 'categories_delete_category' %}"
                                data-pfm-modal-target="delete-category-modal"
                                data-pfm-bind-categoryid="{{ category.id }}"
                                data-pfm-bind-categoryname="{{ category.name }}"
                                data-pfm-bind-deleteurl="{% url 'category_delete' category.id %}">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                            <i data-lucide="grip-vertical" class="w-5 h-5 cursor-grab text-gray-300"
                                aria-hidden="true"></i>
                        </div>
                    </div>
                    {% endfor %}
                    {% else %}
                    <!-- Empty State for Category Group -->
                    <div class="flex flex-col items-center justify-center py-12 text-center bg-green-500/5">
                        <div
                            class="mb-4 flex h-14 w-14 items-center justify-center rounded-full bg-pfm-bg text-green-600/30 shadow-inner">
                            <i data-lucide="inbox" class="w-8 h-8"></i>
                        </div>
                        <p class="text-sm font-semibold text-pfm-text-light/70 uppercase tracking-wide">
                            {% trans "categories_no_income_categories_in_group" %}
                        </p>
                        <button
                            class="modal-open-btn mt-3 text-xs font-bold text-green-600 hover:text-green-700 hover:underline transition-all"
                            data-pfm-modal-target="add-category-modal" data-pfm-bind-group="{{ group.name }}"
                            data-pfm-bind-groupid="{{ group.id }}">
                            + {% trans "categories_add_first_category" %}
                        </button>
                    </div>
                    {% endif %}
                </div>
            </section>
            {% endfor %}
            {% else %}
            <!-- Empty State for Categories Page (No Groups) -->
            <div
                class="flex flex-col items-center justify-center py-20 px-6 text-center rounded-2xl border-2 border-dashed border-pfm-border bg-pfm-card/50 backdrop-blur-sm shadow-sm group hover:border-green-500/30 transition-all duration-300">
                <div
                    class="mb-6 flex h-20 w-20 items-center justify-center rounded-2xl bg-green-500/5 text-green-600 shadow-lg shadow-green-500/10 group-hover:scale-110 transition-transform duration-300">
                    <i data-lucide="layers" class="w-10 h-10"></i>
                </div>
                <h3 class="text-xl font-black text-pfm-text-dark mb-2">
                    {% trans "categories_no_income_groups_title" %}
                </h3>
                <p class="text-pfm-text-light max-w-sm mb-8 leading-relaxed font-medium">
                    {% trans "categories_no_income_groups_desc" %}
                </p>
                <button
                    class="modal-open-btn flex items-center gap-2 rounded-xl bg-green-600 px-8 py-3 text-sm font-bold text-white shadow-xl shadow-green-500/20 hover:bg-green-700 hover:shadow-2xl active:scale-95 transition-all"
                    data-pfm-modal-target="create-group-modal" data-pfm-bind-type="income"
                    data-pfm-bind-typelabel="{% trans 'categories_income' %}">
                    <i data-lucide="plus-circle" class="w-5 h-5"></i>
                    {% trans "categories_create_first_group" %}
                </button>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Modal: Create Category Group -->
<div id="create-group-modal" tabindex="-1" aria-hidden="true"
    class="modal hidden overflow-y-auto overflow-x-hidden fixed inset-0 z-50 justify-center items-center w-full h-full max-h-full bg-black/50 backdrop-blur-sm"
    role="dialog" aria-modal="true" aria-labelledby="modal-title-group">
    <div class="relative p-4 w-full max-w-[560px] max-h-full">
        <!-- Modal content -->
        <div
            class="relative bg-pfm-card rounded-xl shadow-2xl overflow-hidden flex flex-col transition-opacity transition-transform duration-300 ease-out transform-gpu scale-95 opacity-0">
            <div class="flex items-center justify-between border-b border-pfm-border px-6 py-4">
                <div class="flex flex-col">
                    <span id="group-type-badge" data-pfm-modal-bind="typelabel"
                        class="hidden px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider w-fit mb-1">
                        {% trans "categories_expenses" %}
                    </span>
                    <h2 id="modal-title-group" class="text-xl font-bold text-pfm-text-dark" data-pfm-modal-bind="title">
                        {% trans "categories_add_group" %}
                    </h2>
                </div>
                <button type="button"
                    class="modal-close-btn text-pfm-text-light hover:text-pfm-text-dark transition-colors"
                    aria-label="{% trans 'categories_close_modal' %}">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <div class="p-6 overflow-y-auto max-h-[70vh]">
                <form id="create-group-form" method="POST" action="{% url 'category_group_create' %}" class="space-y-6">
                    {% csrf_token %}
                    <input type="hidden" name="transaction_type" id="group-type-input" data-pfm-modal-bind="type"
                        value="expenses">
                    <div>
                        <label class="block text-sm font-semibold text-pfm-text-dark mb-2" for="group-name">
                            {% trans "categories_group_name_label" %}
                        </label>
                        <input
                            class="pfm-input w-full h-12 px-4 rounded-lg bg-pfm-bg border border-pfm-border focus:border-pfm-primary focus:ring-2 focus:ring-pfm-primary/20 outline-none transition-all placeholder:text-pfm-text-light/50 font-medium"
                            id="group-name" name="name" placeholder="{% trans 'categories_group_name_placeholder' %}"
                            data-pfm-modal-bind="groupname" type="text" required autocomplete="off">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-pfm-text-dark mb-2" for="group-description">
                            {% trans "categories_group_description_label" %}
                        </label>
                        <textarea
                            class="pfm-input w-full px-4 py-3 rounded-lg bg-pfm-bg border border-pfm-border focus:border-pfm-primary focus:ring-2 focus:ring-pfm-primary/20 outline-none transition-all placeholder:text-pfm-text-light/50 font-medium"
                            id="group-description" name="description" data-pfm-modal-bind="groupdescription"
                            placeholder="{% trans 'categories_group_description_placeholder' %}" rows="2"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-pfm-text-dark mb-3">
                            {% trans "categories_select_icon" %}
                        </label>
                        <input type="hidden" name="icon" id="group-icon-input" value="folder"
                            data-pfm-modal-bind="groupicon">
                        <div id="group-icon-grid"
                            class="grid grid-cols-6 gap-2 max-h-48 overflow-y-auto p-1 custom-scrollbar">
                            <!-- Dynamically populated -->
                        </div>
                    </div>
                </form>
            </div>
            <div class="flex items-center justify-end gap-3 p-6 bg-pfm-bg/50 border-t border-pfm-border">
                <button type="button"
                    class="modal-close-btn px-6 h-11 rounded-lg text-sm font-bold text-pfm-text-light hover:bg-pfm-bg transition-colors">
                    {% trans "categories_cancel_btn" %}
                </button>
                <button type="submit" form="create-group-form" id="modal-submit-group"
                    class="px-5 py-2.5 rounded-lg bg-pfm-primary text-white font-semibold hover:bg-pfm-primary/90 shadow-md shadow-pfm-primary/20 transition-all">
                    {% trans "categories_create_group_btn" %}
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Add Category -->
<div id="add-category-modal" tabindex="-1" aria-hidden="true"
    class="modal hidden overflow-y-auto overflow-x-hidden fixed inset-0 z-50 justify-center items-center w-full h-full max-h-full bg-black/50 backdrop-blur-sm"
    role="dialog" aria-modal="true" aria-labelledby="modal-title-category">
    <div class="relative p-4 w-full max-w-[480px] max-h-full">
        <!-- Modal content -->
        <div
            class="relative bg-pfm-card rounded-xl shadow-2xl overflow-hidden transition-opacity transition-transform duration-300 ease-out transform-gpu scale-95 opacity-0">
            <div class="px-8 pt-8 pb-4">
                <div id="modal-category-badge-container" class="flex items-center gap-2 mb-2">
                    <span class="text-pfm-primary/80 text-xs font-bold uppercase tracking-wider">
                        {% trans "categories_adding_to_label" %}
                    </span>
                    <span id="target-group-name" data-pfm-modal-bind="group"
                        class="bg-pfm-primary/10 text-pfm-primary px-2 py-0.5 rounded text-xs font-bold">
                        {% trans "categories_financial_expenses_group" %}
                    </span>
                </div>
                <h2 id="modal-title-category" class="text-pfm-text-dark text-2xl font-black tracking-tight">
                    {% trans "categories_add_new_category_title" %}
                </h2>
                <p id="modal-category-desc" class="text-pfm-text-light text-sm mt-1">
                    {% trans "categories_add_category_desc" %}
                </p>
            </div>
            <form id="add-category-form" method="POST" action="{% url 'category_create' %}" class="px-8 py-4 space-y-6">
                {% csrf_token %}
                <input type="hidden" name="group" data-pfm-modal-bind="groupid">
                <div class="flex flex-col gap-2">
                    <label class="text-sm font-bold text-pfm-text-dark" for="category-name">
                        {% trans "categories_category_name_label" %}
                    </label>
                    <input
                        class="pfm-input w-full h-12 px-4 rounded-lg bg-pfm-bg border border-pfm-border focus:border-pfm-primary text-base placeholder:text-pfm-text-light/50 font-medium"
                        id="category-name" name="name" placeholder="{% trans 'categories_category_name_placeholder' %}"
                        data-pfm-modal-bind="categoryname" type="text" required autocomplete="off">
                </div>
                <div class="flex flex-col gap-2">
                    <label class="text-sm font-bold text-pfm-text-dark" for="category-description">
                        {% trans "categories_description_label" %}
                    </label>
                    <textarea
                        class="pfm-input w-full px-4 py-3 rounded-lg bg-pfm-bg border border-pfm-border focus:border-pfm-primary text-base placeholder:text-pfm-text-light/50 resize-none font-medium"
                        id="category-description" name="description" data-pfm-modal-bind="categorydescription"
                        placeholder="{% trans 'categories_description_placeholder' %}" rows="3"></textarea>
                </div>
                <div class="flex flex-col gap-2">
                    <label class="text-sm font-bold text-pfm-text-dark">
                        {% trans "categories_select_icon" %}
                    </label>
                    <input type="hidden" name="icon" id="category-icon-input" value="tag"
                        data-pfm-modal-bind="categoryicon">
                    <div id="category-icon-grid"
                        class="grid grid-cols-6 gap-2 max-h-40 overflow-y-auto p-1 custom-scrollbar">
                        <!-- Dynamically populated -->
                    </div>
                </div>
            </form>
            <div class="px-8 py-6 bg-pfm-bg/50 border-t border-pfm-border flex items-center justify-end gap-3">
                <button type="button"
                    class="modal-close-btn px-6 h-11 rounded-lg text-sm font-bold text-pfm-text-light hover:bg-pfm-bg transition-colors">
                    {% trans "categories_cancel_btn" %}
                </button>
                <button type="submit" form="add-category-form" id="modal-submit-category"
                    class="px-8 h-11 rounded-lg bg-pfm-primary text-white text-sm font-bold shadow-lg shadow-pfm-primary/20 hover:bg-pfm-primary/90 transition-all">
                    {% trans "categories_add_category" %}
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Delete Confirmation -->
<div id="delete-category-modal" tabindex="-1" aria-hidden="true"
    class="modal hidden overflow-y-auto overflow-x-hidden fixed inset-0 z-50 justify-center items-center w-full h-full max-h-full bg-black/50 backdrop-blur-sm"
    role="dialog" aria-modal="true" aria-labelledby="modal-title-delete">
    <div class="relative p-4 w-full max-w-md max-h-full">
        <div
            class="relative bg-pfm-card rounded-xl shadow-2xl overflow-hidden transition-all duration-300 transform-gpu scale-95 opacity-0">
            <div class="p-6 text-center">
                <div
                    class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 dark:bg-red-900/20 mb-4">
                    <i data-lucide="alert-triangle" class="h-6 w-6 text-red-600"></i>
                </div>
                <h3 id="modal-title-delete" class="text-xl font-black text-pfm-text-dark mb-2">
                    {% trans "categories_delete_modal_title" %}
                </h3>
                <div class="text-sm text-pfm-text-light mb-6 text-center">
                    <p class="mb-2">
                        {% trans "categories_delete_modal_msg" %}
                        "<span id="delete-category-name-display" data-pfm-modal-bind="categoryname"
                            class="font-bold text-pfm-text-dark"></span>"?
                    </p>
                    <p class="font-medium text-red-500">
                        {% trans "categories_delete_modal_warning" %}
                    </p>
                </div>
                <input type="hidden" id="delete-category-url-input" data-pfm-modal-bind="deleteurl">
                <div class="flex items-center justify-center gap-3">
                    <button type="button"
                        class="modal-close-btn px-5 py-2.5 rounded-lg text-sm font-bold text-pfm-text-light hover:bg-pfm-bg transition-colors">
                        {% trans "categories_cancel_btn" %}
                    </button>
                    <button id="confirm-delete-category-btn" type="button"
                        class="px-5 py-2.5 rounded-lg bg-red-600 text-white text-sm font-bold shadow-lg shadow-red-500/20 hover:bg-red-700 transition-all active:scale-95">
                        {% trans "categories_delete_btn" %}
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const ICON_CONFIG = {
            group: [
                { name: 'folder', label: '{% trans "icon_folder" %}' },
                { name: 'banknote', label: '{% trans "icon_banknote" %}' },
                { name: 'credit-card', label: '{% trans "icon_credit_card" %}' },
                { name: 'wallet', label: '{% trans "icon_wallet" %}' },
                { name: 'piggy-bank', label: '{% trans "icon_piggy_bank" %}' },
                { name: 'coins', label: '{% trans "icon_coins" %}' },
                { name: 'home', label: '{% trans "icon_home" %}' },
                { name: 'shopping-cart', label: '{% trans "icon_shopping_cart" %}' },
                { name: 'utensils', label: '{% trans "icon_utensils" %}' },
                { name: 'coffee', label: '{% trans "icon_coffee" %}' },
                { name: 'car', label: '{% trans "icon_car" %}' },
                { name: 'heart', label: '{% trans "icon_heart" %}' },
                { name: 'tv', label: '{% trans "icon_tv" %}' },
                { name: 'book', label: '{% trans "icon_book" %}' },
                { name: 'gamepad', label: '{% trans "icon_gamepad" %}' },
                { name: 'music', label: '{% trans "icon_music" %}' },
                { name: 'plane', label: '{% trans "icon_plane" %}' },
                { name: 'briefcase', label: '{% trans "icon_briefcase" %}' }
            ],
            category: [
                { name: 'tag', label: '{% trans "icon_tag" %}' },
                { name: 'gift', label: '{% trans "icon_gift" %}' },
                { name: 'dumbbell', label: '{% trans "icon_dumbbell" %}' },
                { name: 'pill', label: '{% trans "icon_pill" %}' },
                { name: 'pizza', label: '{% trans "icon_pizza" %}' },
                { name: 'bus', label: '{% trans "icon_bus" %}' },
                { name: 'star', label: '{% trans "icon_star" %}' },
                { name: 'sparkles', label: '{% trans "icon_sparkles" %}' },
                { name: 'ticket', label: '{% trans "icon_ticket" %}' },
                { name: 'plug', label: '{% trans "icon_plug" %}' },
                { name: 'trash-2', label: '{% trans "icon_trash" %}' },
                { name: 'hammer', label: '{% trans "icon_hammer" %}' },
                { name: 'apple', label: '{% trans "icon_apple" %}' },
                { name: 'beer', label: '{% trans "icon_beer" %}' },
                { name: 'film', label: '{% trans "icon_film" %}' },
                { name: 'train', label: '{% trans "icon_train" %}' },
                { name: 'bike', label: '{% trans "icon_bike" %}' },
                { name: 'zap', label: '{% trans "icon_zap" %}' }
            ]
        };

        function renderIconGrid(containerId, icons, targetInputId, defaultIcon) {
            const grid = document.getElementById(containerId);
            if (!grid) return;

            grid.innerHTML = icons.map(icon => {
                const isActive = icon.name === defaultIcon;
                const activeClasses = 'border-2 border-pfm-primary bg-pfm-primary/5 text-pfm-primary';
                const inactiveClasses = 'border border-pfm-border hover:border-pfm-primary/50 hover:bg-pfm-bg text-pfm-text-light';

                return `
                    <button type="button" 
                        class="icon-option flex items-center justify-center aspect-square rounded-lg transition-all ${isActive ? activeClasses : inactiveClasses}"
                        data-icon="${icon.name}" 
                        data-pfm-icon-target="${targetInputId}" 
                        aria-label="${icon.label}">
                        <i data-lucide="${icon.name}" class="w-5 h-5"></i>
                    </button>
                `;
            }).join('');
        }

        // Initialize grids
        renderIconGrid('group-icon-grid', ICON_CONFIG.group, 'group-icon-input', 'folder');
        renderIconGrid('category-icon-grid', ICON_CONFIG.category, 'category-icon-input', 'tag');

        // Re-initialize Lucide icons
        if (window.lucide) {
            window.lucide.createIcons();
        }

        // Event Delegation for Icon selection
        document.addEventListener('click', (e) => {
            const opt = e.target.closest('.icon-option');
            if (!opt) return;

            const targetInputId = opt.getAttribute('data-pfm-icon-target');
            const targetInput = document.getElementById(targetInputId);
            const iconName = opt.getAttribute('data-icon');

            if (targetInput) {
                targetInput.value = iconName;

                // Update UI: sibling buttons in the same grid
                const siblings = opt.parentElement.querySelectorAll('.icon-option');
                siblings.forEach(s => {
                    s.classList.remove('border-pfm-primary', 'border-2', 'bg-pfm-primary/5', 'text-pfm-primary');
                    s.classList.add('border', 'border-pfm-border', 'text-pfm-text-light');
                });

                opt.classList.add('border-2', 'border-pfm-primary', 'bg-pfm-primary/5', 'text-pfm-primary');
                opt.classList.remove('border', 'border-pfm-border', 'text-pfm-text-light');
            }
        });
        // Tab switching augmentation for Create Group button
        const createGroupBtn = document.getElementById('create-group-btn');
        const tabBtns = document.querySelectorAll('[data-pfm-tab-target]');
        const typeBadge = document.getElementById('group-type-badge');

        function updateCreateButton(target, label) {
            if (!createGroupBtn) return;

            createGroupBtn.setAttribute('data-pfm-bind-type', target);
            createGroupBtn.setAttribute('data-pfm-bind-typelabel', label);

            // Sync button color with type for premium feel
            if (target === 'income') {
                createGroupBtn.classList.remove('bg-pfm-primary', 'shadow-pfm-primary/20', 'hover:bg-pfm-primary-hover');
                createGroupBtn.classList.add('bg-green-600', 'shadow-green-500/20', 'hover:bg-green-700');
            } else {
                createGroupBtn.classList.add('bg-pfm-primary', 'shadow-pfm-primary/20', 'hover:bg-pfm-primary-hover');
                createGroupBtn.classList.remove('bg-green-600', 'shadow-green-500/20', 'hover:bg-green-700');
            }
        }

        tabBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const target = btn.getAttribute('data-pfm-tab-target');
                const label = btn.getAttribute('data-pfm-label') || btn.innerText.trim();

                updateCreateButton(target, label);

                // Show type badge in modal and sync colors
                if (typeBadge) {
                    typeBadge.classList.remove('hidden');
                    if (target === 'income') {
                        typeBadge.classList.remove('bg-pfm-primary/10', 'text-pfm-primary');
                        typeBadge.classList.add('bg-green-500/10', 'text-green-600');
                    } else {
                        typeBadge.classList.add('bg-pfm-primary/10', 'text-pfm-primary');
                        typeBadge.classList.remove('bg-green-500/10', 'text-green-600');
                    }
                }
            });
        });

        // Initialize with server-provided tab
        const currentTab = "{{ active_tab }}";
        const initialTab = document.querySelector(`[data-pfm-tab-target="${currentTab}"]`);

        if (initialTab) {
            updateCreateButton(
                initialTab.getAttribute('data-pfm-tab-target'),
                initialTab.getAttribute('data-pfm-label') || initialTab.innerText.trim()
            );
        }

        // Global Modal Opening Sync for Colors and Form Reset
        document.addEventListener('click', (e) => {
            const btn = e.target.closest('.modal-open-btn');
            if (!btn) return;

            const modalId = btn.getAttribute('data-pfm-modal-target');

            // Handle Create Group Modal
            if (modalId === 'create-group-modal') {
                const form = document.getElementById('create-group-form');
                const titleEl = document.getElementById('modal-title-group');
                const submitBtn = document.getElementById('modal-submit-group');
                const isEdit = btn.getAttribute('data-pfm-bind-mode') === 'edit';

                if (isEdit) {
                    const groupId = btn.getAttribute('data-pfm-bind-groupid');
                    const groupIcon = btn.getAttribute('data-pfm-bind-groupicon') || 'folder';
                    const updateUrl = btn.getAttribute('data-pfm-bind-updateurl');

                    if (titleEl) titleEl.textContent = "{% trans 'categories_edit_group_title' %}";
                    if (submitBtn) submitBtn.textContent = "{% trans 'categories_save_changes_btn' %}";

                    if (form) {
                        form.action = updateUrl || `/categories/group/${groupId}/update/`;
                    }

                    setTimeout(() => {
                        const iconOpt = document.querySelector(`#group-icon-grid [data-icon="${groupIcon}"]`);
                        if (iconOpt) iconOpt.click();
                    }, 50);
                } else {
                    if (titleEl) titleEl.textContent = "{% trans 'categories_add_group' %}";
                    if (submitBtn) submitBtn.textContent = "{% trans 'categories_create_group_btn' %}";

                    if (form) {
                        form.action = "{% url 'category_group_create' %}";
                        form.reset();
                    }

                    const folderOpt = document.querySelector('#group-icon-grid [data-icon="folder"]');
                    if (folderOpt) folderOpt.click();
                }

                const target = btn.getAttribute('data-pfm-tab-target') || btn.getAttribute('data-pfm-bind-type');
                if (typeBadge && target) {
                    typeBadge.classList.remove('hidden');
                    if (target === 'income') {
                        typeBadge.classList.remove('bg-pfm-primary/10', 'text-pfm-primary');
                        typeBadge.classList.add('bg-green-500/10', 'text-green-600');
                    } else {
                        typeBadge.classList.add('bg-pfm-primary/10', 'text-pfm-primary');
                        typeBadge.classList.remove('bg-green-500/10', 'text-green-600');
                    }
                }
            }

            // Handle Add Category Modal
            if (modalId === 'add-category-modal') {
                const form = document.getElementById('add-category-form');
                const titleEl = document.getElementById('modal-title-category');
                const submitBtn = document.getElementById('modal-submit-category');
                const badgeContainer = document.getElementById('modal-category-badge-container');
                const descEl = document.getElementById('modal-category-desc');
                const isEdit = btn.getAttribute('data-pfm-bind-mode') === 'edit';

                if (form) {
                    form.reset();
                    // Reset icon highlights
                    const options = document.querySelectorAll('#category-icon-grid .icon-option');
                    options.forEach(opt => {
                        opt.classList.remove('border-pfm-primary', 'border-2', 'bg-pfm-primary/5', 'text-pfm-primary');
                        opt.classList.add('border', 'border-pfm-border', 'text-pfm-text-light');
                    });
                }

                if (isEdit) {
                    const updateUrl = btn.getAttribute('data-pfm-bind-updateurl');
                    const categoryIcon = btn.getAttribute('data-pfm-bind-categoryicon') || 'tag';
                    const categoryDesc = btn.getAttribute('data-pfm-bind-categorydescription') || '';
                    const categoryName = btn.getAttribute('data-pfm-bind-categoryname') || '';
                    const categoryGroupId = btn.getAttribute('data-pfm-bind-categorygroupid');

                    if (titleEl) titleEl.textContent = "{% trans 'categories_edit_category' %}";
                    if (submitBtn) submitBtn.textContent = "{% trans 'categories_save_changes_btn' %}";
                    if (descEl) descEl.textContent = "{% trans 'categories_edit_category_desc' %}";
                    if (badgeContainer) badgeContainer.classList.add('hidden');

                    if (form) {
                        form.action = updateUrl;
                        // Populate fields explicitly
                        const nameInput = form.querySelector('[name="name"]');
                        const descInput = form.querySelector('[name="description"]');
                        const groupInput = form.querySelector('[name="group"]');

                        if (nameInput) nameInput.value = categoryName;
                        if (descInput) descInput.value = categoryDesc;
                        if (groupInput) groupInput.value = categoryGroupId;
                    }

                    setTimeout(() => {
                        const iconOpt = document.querySelector(`#category-icon-grid [data-icon="${categoryIcon}"]`);
                        if (iconOpt) iconOpt.click();
                    }, 50);

                } else {
                    if (titleEl) titleEl.textContent = "{% trans 'categories_add_category' %}";
                    if (submitBtn) submitBtn.textContent = "{% trans 'categories_add_category' %}";
                    if (descEl) descEl.textContent = "{% trans 'categories_add_category_desc' %}";
                    if (badgeContainer) badgeContainer.classList.remove('hidden');

                    if (form) {
                        form.action = "{% url 'category_create' %}";
                        // Pre-select tag icon for new categories
                        setTimeout(() => {
                            const tagOpt = document.querySelector(`#category-icon-grid [data-icon="tag"]`);
                            if (tagOpt) tagOpt.click();
                        }, 50);
                    }
                }
            }
        });

        // Form AJAX submission
        const forms = ['create-group-form', 'add-category-form'];
        forms.forEach(formId => {
            const form = document.getElementById(formId);
            if (form) {
                form.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const formData = new FormData(form);
                    const url = form.getAttribute('action');

                    fetch(url, {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                        }
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === 'success') {
                                // Smoothly reload the page with current tab persisted
                                const currentActiveTab = sessionStorage.getItem('activeTab-category-type') || 'expenses';
                                window.location.href = window.location.pathname + '?tab=' + currentActiveTab;
                            } else {
                                let errorMsg = data.message || 'An error occurred';
                                if (data.errors) {
                                    errorMsg += '\n' + JSON.stringify(data.errors, null, 2);
                                }
                                alert(errorMsg);
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            alert('An unexpected error occurred');
                        });
                });
            }
        });
        // Handle Delete Category Confirmation
        const confirmDeleteBtn = document.getElementById('confirm-delete-category-btn');
        if (confirmDeleteBtn) {
            confirmDeleteBtn.addEventListener('click', () => {
                const deleteUrlInput = document.getElementById('delete-category-url-input');
                const deleteUrl = deleteUrlInput ? deleteUrlInput.value : null;

                if (deleteUrl) {
                    confirmDeleteBtn.disabled = true;
                    confirmDeleteBtn.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i>';
                    if (typeof lucide !== 'undefined') lucide.createIcons();

                    fetch(deleteUrl, {
                        method: 'POST',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                        }
                    })
                        .then(response => {
                            if (!response.ok) {
                                return response.text().then(text => {
                                    throw new Error(`HTTP ${response.status}: ${text.substring(0, 100)}`);
                                });
                            }
                            return response.json();
                        })
                        .then(data => {
                            if (data.status === 'success') {
                                const currentActiveTab = sessionStorage.getItem('activeTab-category-type') || 'expenses';
                                window.location.href = window.location.pathname + '?tab=' + currentActiveTab;
                            } else {
                                confirmDeleteBtn.disabled = false;
                                confirmDeleteBtn.textContent = "{% trans 'categories_delete_btn' %}";
                                alert(data.message || 'Error deleting category');
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            confirmDeleteBtn.disabled = false;
                            confirmDeleteBtn.textContent = "{% trans 'categories_delete_btn' %}";
                            alert('An unexpected error occurred');
                        });
                }
            });
        }
    });
</script>
{% endblock %}